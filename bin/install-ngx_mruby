#!/usr/bin/env bash
set -ev

source .ngx_mruby-version

# Clean
cd vendor
rm -fr ngx_mruby-*

# Get source
wget -O - https://github.com/matsumoto-r/ngx_mruby/archive/v$NGX_MRUBY_VERSION.tar.gz | tar xzf -

# Add mruby-jwt gem
cd ngx_mruby-${NGX_MRUBY_VERSION}
sed -i.bak "s/^end$/  conf.gem :github => 'prevs-io\/mruby-jwt'\\
  conf.gem :github => 'mattn\/mruby-base64'\\
end/" build_config.rb

# Set config options
if [ -z ${NGINX_CONFIG_OPT_ENV} ]; then
  NGINX_CONFIG_OPT_ENV="--prefix=$(pwd)/build/nginx --with-http_ssl_module"

  if [ $(which brew) ]; then
    brew update
    brew install openssl || 0
    OPENSSL_PATH=$(brew --prefix openssl)
    NGINX_CONFIG_OPT_ENV+=" --with-cc-opt=-I${OPENSSL_PATH}/include --with-ld-opt=-L${OPENSSL_PATH}/lib"
  fi
fi

# Work around Makefile build_mruby using git to revert changes to mruby/build_config.rb
git init
git add mruby/build_config.rb

# Build
NGINX_CONFIG_OPT_ENV="${NGINX_CONFIG_OPT_ENV}" sh build.sh

# Install
make install
