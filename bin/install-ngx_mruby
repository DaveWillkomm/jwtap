#!/usr/bin/env bash
set -ev

source .ngx_mruby-version

# Get ngx_mruby
rm -fr vendor/v*.tar.gz vendor/ngx_mruby-*
cd vendor
wget https://github.com/matsumoto-r/ngx_mruby/archive/v$NGX_MRUBY_VERSION.tar.gz
tar xf v$NGX_MRUBY_VERSION.tar.gz
cd ngx_mruby-$NGX_MRUBY_VERSION

# Add mruby-jwt
sed -i.bak "s/^end$/  conf.gem :github => 'prevs-io\/mruby-jwt'\\
end/" build_config.rb

# Work around Makefile build_mruby using git to revert changes to mruby/build_config.rb
git init
git add mruby/build_config.rb

# Build
NGINX_CONFIG_OPT_ENV="--prefix=${1:-`pwd`/build/nginx}" sh build.sh

# Install
make install
